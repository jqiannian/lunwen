# MVP 配置（修正版）
# Generated: 2025-12-03
# Based on: TECHNICAL_CORRECTIONS.md, Design-ITER-2025-01.md

# === 运行时配置 ===
runtime:
  seed: 42
  device: "cuda:0"  # 选项: "cuda:0" | "cpu" | "mps" (Apple M系列)
  precision: "fp32"  # 选项: "fp32" | "fp16" (混合精度，节省显存)
  num_threads: 4     # CPU线程数

# === 路径配置 ===
paths:
  data_root: "${DATA_ROOT:-data}"  # 环境变量，默认data/
  artifact_root: "${ARTIFACT_ROOT:-artifacts}"
  checkpoint_dir: "artifacts/checkpoints"
  pseudo_label_dir: "artifacts/pseudo_labels"
  report_dir: "reports"
  log_dir: "logs"

# === 数据配置 ===
data:
  dataset: "synthetic"  # 选项: synthetic | bdd100k | cityscapes
  batch_size: 4         # RTX 4090: 4-8, CPU: 1-2
  num_workers: 2        # 数据加载器worker数
  max_samples: 100      # 训练样本数（MVP阶段）
  
  # 数据增强
  augmentations:
    enable: true
    brightness_jitter: 0.2    # 亮度扰动 ±0.2
    contrast_jitter: 0.2      # 对比度扰动 ±0.2
    crop_probability: 0.3     # 随机裁剪概率
    horizontal_flip: 0.5      # 水平翻转概率
  
  # 场景图构建
  graph:
    spatial_radius: 50.0      # 空间邻接半径（米）
    max_nodes: 50             # 最大节点数（防止OOM）
    vehicle_vehicle_radius: 30.0   # 车辆-车辆连接半径
    vehicle_light_radius: 50.0     # 车辆-交通灯连接半径
    vehicle_stop_radius: 100.0     # 车辆-停止线连接半径

# === 模型配置 ===
model:
  # 基础架构（根据GAT/Transformer基线）
  input_dim: 10          # 实体特征维度
  hidden_dim: 128        # GAT隐藏层维度（参考: GAT原文）
  num_gat_layers: 3      # GAT层数（2-4层避免过平滑）
  num_heads: 8           # 多头注意力头数（参考: Transformer）
  dropout: 0.1           # Dropout概率（标准正则化率）
  
  # 全局注意力
  global_attention:
    enable: true
    num_heads: 4         # 全局注意力头数
  
  # 规则聚焦注意力
  rule_attention:
    enable: true
    num_rules: 5         # 支持的规则数量（红灯停、车速、车道...）
  
  # 记忆库（可选）
  memory_bank:
    enable: false        # MVP阶段禁用，ITER-02启用
    size: 512            # 记忆槽数量
    dim: 128             # 记忆维度
    temperature: 0.07    # 检索温度
    refresh_interval: 100  # 更新间隔（epoch）

# === 规则配置（修正版，完全可导） ===
rules:
  red_light_stop:
    enabled: true
    
    # 阈值参数
    distance_threshold: 5.0    # 停止线距离阈值（米）
    speed_threshold: 0.5       # 速度阈值（米/秒）
    
    # 软化参数（控制函数陡峭度）
    alpha_distance: 2.0        # 距离敏感度（修正后）
    alpha_velocity: 5.0        # 速度敏感度（修正后）
    
    # Gumbel-Softmax参数
    gumbel_temperature: 0.5    # 训练时温度（新增）
    
    # 软化系数（避免除零）
    epsilon_dist: 1.0          # 距离软化系数
    epsilon_vel: 0.2           # 速度软化系数
    
    # 注意力一致性
    enforce_attention_consistency: true
    violation_threshold: 0.5   # 违规判定阈值

# === 损失函数配置（修正后权重） ===
loss:
  # 权重（基于TECHNICAL_CORRECTIONS.md）
  lambda_recon: 1.0          # BCE重构损失（隐式权重）
  lambda_rule: 0.5           # 规则一致性损失
  lambda_attn: 0.3           # 注意力一致性损失
  lambda_reg: 1.0e-4         # L2正则化损失
  
  # 注意力一致性参数
  attention_consistency:
    violation_threshold: 0.5  # 规则评分超过此值认为违规
    focus_threshold: 0.3      # 注意力聚焦阈值

# === 训练配置 ===
training:
  epochs: 100               # 总训练轮数
  learning_rate: 1.0e-4     # AdamW学习率（图网络经验值）
  weight_decay: 1.0e-4      # 权重衰减
  gradient_clip: 1.0        # 梯度裁剪范数
  
  # 学习率调度
  scheduler:
    type: "cosine"          # 选项: cosine | step | exponential
    T_max: 100              # CosineAnnealing周期
    warmup_epochs: 10       # 预热轮数（可选）
  
  # Early Stopping
  early_stopping:
    enable: true
    patience: 10            # 连续10 epochs无提升则停止
    min_delta: 0.001        # 最小改进阈值
  
  # 验证
  validation:
    interval: 5             # 每5 epochs验证一次
    split_ratio: 0.2        # 验证集比例
  
  # Checkpoint
  checkpoint:
    save_interval: 5        # 每5 epochs保存
    keep_top_k: 3           # 保留top-3模型
    metric: "val_auc"       # 选择指标: val_auc | val_f1 | val_loss

# === 监控配置 ===
monitoring:
  # Prometheus
  prometheus:
    enable: true
    port: 8000              # 监控端口
    update_interval: 50     # 每50步更新指标
  
  # 日志
  logging:
    level: "INFO"           # 选项: DEBUG | INFO | WARNING | ERROR
    format: "json"          # 选项: json | text
    file: "logs/training.log"
  
  # 可解释性输出
  explainability:
    attention_snapshot_limit: 25  # 最多保存25个注意力快照
    save_attention_maps: true     # 是否保存注意力热力图
    save_rule_explanations: true  # 是否保存规则解释

# === 自训练配置（双路径策略） ===
self_training:
  enabled: false           # MVP阶段禁用，后期启用
  
  # 策略选择（动态切换）
  strategy: "rule_priority"  # 选项: rule_priority | weighted_fusion | model_priority
  
  # 策略切换条件
  strategy_switching:
    epoch_threshold_fusion: 20      # Epoch≥20切换到加权融合
    epoch_threshold_model: 60       # Epoch≥60切换到模型优先
    reliability_threshold: 0.85     # 模型可靠度阈值
  
  # 规则优先策略（Epoch 0-20）
  rule_priority:
    confidence_threshold: 0.85      # 置信度阈值
    consistency_threshold: 0.2      # 模型-规则差异容忍度
    attention_threshold: 0.3        # 注意力聚焦阈值
  
  # 加权融合策略（Epoch 20-60）
  weighted_fusion:
    weight_rule: 0.6                # 规则权重
    weight_model: 0.4               # 模型权重
    confidence_threshold: 0.85
  
  # 模型优先策略（Epoch 60+）
  model_priority:
    confidence_threshold: 0.9
    reliability_threshold: 0.9
  
  # 安全约束
  safety:
    max_samples_per_epoch_ratio: 0.2    # 最多生成20%伪标签
    pseudo_label_weight: 0.3             # 伪标签训练权重
    manual_review_interval: 10           # 每10 epochs人工复核
    manual_review_samples: 10            # 每次复核10个样本
    
    # 损失监控（防止崩溃）
    attention_loss_threshold: 0.5        # 注意力损失阈值
    attention_loss_patience: 3           # 容忍连续3 epochs上升
    confidence_decrease_step: 0.05       # 阈值降低步长

# === 评估配置 ===
evaluation:
  metrics:
    - "auc"                # AUC-ROC
    - "f1"                 # F1 Score
    - "precision"          # Precision
    - "recall"             # Recall
    - "attention_consistency"  # 注意力一致性
  
  # 目标值（MVP synthetic数据）
  targets:
    auc: 0.90
    f1: 0.85
    precision: 0.85
    recall: 0.85
    attention_consistency: 0.75
  
  # 场景测试
  scenarios:
    - name: "parking"      # 红灯停车
      expected_violations: 0
    - name: "violation"    # 红灯闯行
      expected_violations: 1
    - name: "green_pass"   # 绿灯通过
      expected_violations: 0

# === 实验追踪（可选） ===
experiment:
  name: "mvp-red-light-stop"
  tags:
    - "iter-2025-01"
    - "gumbel-softmax"
    - "multi-stage-attention"
  
  # Weights & Biases（可选）
  wandb:
    enable: false
    project: "traffic-rules-mvp"
    entity: "your-team"

# === 超参数网格搜索（ITER-02）===
hyperparameter_tuning:
  enable: false            # MVP阶段禁用
  method: "grid"           # 选项: grid | random | optuna
  
  search_space:
    lambda_rule: [0.1, 0.3, 0.5, 0.7, 1.0]
    lambda_attn: [0.0, 0.1, 0.3, 0.5, 0.6]
    learning_rate: [5.0e-5, 1.0e-4, 2.0e-4, 5.0e-4]
    distance_threshold: [3.0, 5.0, 7.0, 10.0]
