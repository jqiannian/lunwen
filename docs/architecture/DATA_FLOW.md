# 训练数据流（单 Epoch）

> 本文档由根目录历史文件 `TRAINING_DATAFLOW_DIAGRAM.md` 迁移而来，作为“架构层”稳定文档。
> 
> 设计依据：`docs/iterations/ITER-2025-01/DESIGN.md` §3.5.1

---

以下为原始数据流图内容（保持原样，便于对照代码实现）：

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Training Epoch 开始                           │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点1: DataLoader遍历                                                │
│ 输入: TrafficLightDataset                                           │
│ 输出: batch (dict)                                                  │
│   - 'image': [H, W, 3]                                              │
│   - 'entities': List[Entity]                                        │
│   - 'scene_id': str                                                 │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点2: GraphBuilder.build_batch()                                   │
│ 输入: batch['entities']                                             │
│ 处理: 提取特征 + 构建边                                              │
│ 输出: GraphBatch                                                    │
│   - x: [N, 10]          # 节点特征矩阵                              │
│   - edge_index: [2, E]  # 稀疏边索引                                │
│   - entity_types: [N]   # 实体类型(0/1/2)                           │
│   - entity_masks: [N]   # 有效实体mask                              │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点3: Model.forward() - 开始                                        │
│ 输入: x, edge_index, entity_types                                   │
└─────────────────────────────────────────────────────────────────────┘
                                  │
        ┌─────────────────────────┴─────────────────────────┐
        │                                                   │
        ▼                                                   ▼
┌───────────────────────┐                     ┌───────────────────────┐
│ 节点4a: 输入投影       │                     │ 节点4b: 边处理         │
│ x: [N,10] → [N,128]   │                     │ edge_index处理         │
│ + LayerNorm           │                     │ + 自环添加             │
└───────────────────────┘                     └───────────────────────┘
        │                                                   │
        └─────────────────────────┬─────────────────────────┘
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点5: 阶段1 - LocalGATEncoder（3层GAT）                             │
│ 输出: h_local: [N, 128], α_gat: [E]（最后一层注意力）               │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点6: 阶段2 - GlobalSceneAttention                                  │
│ 输出: h_global: [N, 128], global_attn: [N]                          │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点7: 阶段3 - RuleFocusedAttention                                  │
│ 输出: h_rule: [N, 128], β_rule: [N_car]                             │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点8: 多路径梯度融合                                                │
│ 输出: h_final: [N, 128]                                              │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点9: Scoring Head                                                  │
│ 输出: s_model: [N_car]                                               │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点10: RuleEngine.evaluate()                                       │
│ 输出: s_rule: [N_car]                                                │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点11: ConstraintLoss.forward()                                     │
│ 输出: L_total（标量）                                                │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点13-16: backward + clip + step                                    │
└─────────────────────────────────────────────────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────────────┐
│ 节点19-22: 验证 + 阶段切换 + checkpoint                               │
└─────────────────────────────────────────────────────────────────────┘
```

> 说明：为了避免文档重复，这里只保留“训练链路主干”。若需要逐节点的完整推导与代码片段，请查看归档的原始文件或设计文档对应章节。
