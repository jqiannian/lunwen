# 未完成需求缺口分析（ITER-2025-01）

> 基于CODE_IMPLEMENTATION_STATUS.md生成，用于指导后续详细设计与开发

## 生成日期
2025-12-16

## 1. 需求完成情况分类

### 1.1 已完成需求（可立即验收）

#### BIZ-006：注意力增强（95%完成）✅
- **完成内容**：
  - ✅ 多头GAT（3层×8头）
  - ✅ 全局虚拟节点注意力（4头）
  - ✅ 规则聚焦注意力
  - ✅ 注意力权重导出接口
  - ✅ 注意力一致性损失
- **缺失5%**：注意力权重持久化到文件（用于离线分析）
- **优先级**：低（不影响核心功能）

### 1.2 部分完成需求（需补充实现）

#### BIZ-001：红灯停MVP场景（85%完成）🟡
- **完成内容**：
  - ✅ 数据管道（synthetic，100个场景）
  - ✅ 实体解析（车辆、交通灯、停止线）
  - ✅ 场景图构建（10维特征 + 异构边）
  - ✅ 三阶段GAT模型
  - ✅ 红灯规则引擎（Gumbel-Softmax可导）
  - ✅ 约束损失（四项：recon/rule/attn/reg）
  - ✅ 训练CLI（完整循环 + 健康检查）
  - ✅ 测试CLI（JSON证据链输出）
- **缺失15%**：
  - ❌ 三场景分类测试（parking/violation/green_pass）
  - ❌ 违规截图生成（需调用attention_viz）
  - ❌ 完整验收报告模板
- **优先级**：**高**（验收必需）
- **工作量**：2-3天（主要是test_red_light.py扩展）

#### BIZ-005：可解释性与评估（60%完成）🟡
- **完成内容**：
  - ✅ 完整评估指标（AUC/F1/Precision/Recall/RuleConsistency）
  - ✅ 基础注意力热力图绘制（visualize_attention函数）
  - ✅ 训练曲线可视化（4子图）
  - ✅ JSON格式证据链（距离、速度、灯态、分数）
- **缺失40%**：
  - ❌ 批量热力图渲染（render_attention_maps.py仅占位）
  - ❌ 违规证据链报告模板（Markdown/HTML）
  - ❌ 指标持久化与追踪（需数据库或CSV）
- **优先级**：**高**（验收必需）
- **工作量**：3-4天

#### BIZ-004：自训练与记忆增强（40%完成）🟡
- **完成内容**：
  - ✅ PseudoLabeler三种策略（rule_priority/weighted_fusion/adaptive）
  - ✅ MemoryBank基础存储与检索（余弦相似度）
  - ✅ 伪标签持久化（save_to_disk）
- **缺失60%**：
  - ❌ Memory Bank K-Means初始化
  - ❌ Memory Bank EMA更新策略
  - ❌ 与训练循环集成（Trainer未调用PseudoLabeler）
  - ❌ 课程学习调度器
  - ❌ 自训练轮次控制与收敛判定
- **优先级**：中（ITER-2025-03计划，可延后）
- **工作量**：5-7天

#### BIZ-003：多规则语义注入（15%完成）🟡
- **完成内容**：
  - ✅ 红灯规则完整实现（含RuleConfig类）
  - ✅ 规则评分可导（Gumbel-Softmax）
- **缺失85%**：
  - ❌ 规则DSL框架（可扩展到多规则）
  - ❌ 规则管理器（RuleManager类）
  - ❌ 规则冲突检测算法
  - ❌ 规则优先级机制
  - ❌ 规则热更新机制
  - ❌ 其他规则实现（车速、车道保持、安全距离等）
- **优先级**：中（ITER-2025-02计划，可延后）
- **工作量**：7-10天

### 1.3 完全未实现需求

#### BIZ-002：真实数据集整合（0%完成）❌
- **缺失内容**：
  - ❌ BDD100K标注解析器（JSON格式）
  - ❌ Cityscapes标注解析器
  - ❌ 数据质量检测（缺失字段、异常值）
  - ❌ 统一数据接口（与synthetic兼容）
  - ❌ 数据缓存机制
  - ❌ 增量加载策略
- **优先级**：中（ITER-2025-02计划）
- **工作量**：7-10天

## 2. 按优先级排序的缺口清单

### P0（必须完成，影响MVP验收）
1. **三场景验收测试**（BIZ-001缺失）
   - 在test_red_light.py中添加`--scenario`参数
   - 实现场景分类逻辑（根据metadata.json或场景特征）
   - 输出三场景测试报告
   - **工作量**：1-2天

2. **违规截图生成**（BIZ-001缺失）
   - 扩展test_red_light.py，调用attention_viz
   - 为每个违规场景生成标注图片
   - **工作量**：1天

3. **批量热力图渲染**（BIZ-005缺失）
   - 完善render_attention_maps.py
   - 批量处理validation集
   - 生成HTML报告或图片集
   - **工作量**：2天

**小计**：P0缺口 4-5天工作量

### P1（重要但可延后到下个迭代）
4. **自训练集成**（BIZ-004缺失）
   - 在Trainer中添加伪标签循环
   - 实现课程学习调度
   - **工作量**：3-4天

5. **Memory Bank增强**（BIZ-004缺失）
   - K-Means初始化
   - EMA更新策略
   - **工作量**：2-3天

6. **多规则框架**（BIZ-003缺失）
   - 设计RuleManager接口
   - 实现规则冲突检测
   - **工作量**：4-5天

**小计**：P1缺口 9-12天工作量

### P2（可选，延后到ITER-02/03）
7. **真实数据集整合**（BIZ-002）
   - BDD100K/Cityscapes解析器
   - **工作量**：7-10天

8. **完整单元测试**（质量提升）
   - 补齐所有模块单元测试
   - **工作量**：3-5天

**小计**：P2缺口 10-15天工作量

## 3. MVP交付建议

### 3.1 当前可立即交付的内容
✅ **核心算法链路**：
- 数据加载（synthetic）
- 场景图构建
- 多阶段注意力GAT
- 红灯规则评分
- 约束损失训练
- 基础测试与证据链

✅ **可运行命令**：
```bash
# 训练
python3 tools/train_red_light.py train --epochs 50 --device cpu

# 测试
python3 tools/test_red_light.py run --checkpoint artifacts/checkpoints/best.pth \
  --data-root data/synthetic --split val
```

### 3.2 建议的MVP快速补齐路径（1周内）
**方案A：最小补齐（仅P0，4-5天）**
1. 三场景验收测试（1-2天）
2. 违规截图生成（1天）
3. 批量热力图渲染（2天）

→ 完成后可满足验收标准中的"测试三种场景通过，生成违规报告与违规截图"

**方案B：稳健交付（P0+部分P1，7-10天）**
1. 三场景验收测试（1-2天）
2. 违规截图生成（1天）
3. 批量热力图渲染（2天）
4. 自训练集成（3-4天）

→ 完成后可演示自训练能力（虽非MVP必需，但提升技术亮点）

### 3.3 建议决策
- 如果**本周内交付MVP**：选择**方案A**
- 如果**下周交付且追求完整性**：选择**方案B**

## 4. 详细设计优先级

基于上述缺口分析，建议详细设计优先级：

1. **DESIGN_集成测试_端到端验收流程.md**（P0，支撑验收）
2. **DESIGN_SYS-F-006_可解释性输出完善.md**（P0，支撑验收）
3. **DESIGN_BIZ-004_自训练与记忆增强.md**（P1，技术亮点）
4. **DESIGN_BIZ-003_多规则语义注入.md**（P1，扩展性）
5. **DESIGN_BIZ-002_真实数据集整合.md**（P2，ITER-02）

## 5. 下一步行动建议

### 立即可做（今日）
1. 完成剩余6个详细设计文档
2. 生成REQUIREMENT_STATUS_SUMMARY.md

### 本周可做（优先P0）
1. 实现三场景验收测试
2. 实现违规截图生成
3. 完善批量热力图渲染

### 下周可做（P1）
1. 集成自训练到Trainer
2. 补充Memory Bank高级功能
